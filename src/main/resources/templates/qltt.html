<!DOCTYPE html>
<html lang="vi">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Quản Lý Thông Tin Cá Nhân</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<style>
		@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

		body {
			font-family: 'Inter', sans-serif;
		}
	</style>
</head>

<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen relative">

	<div class="fixed top-4 left-4 z-50">
		<a href="http://localhost:8081/page/home"
			class="flex items-center gap-2 bg-white shadow-md hover:shadow-lg transition p-2 rounded-full text-blue-600 font-semibold hover:bg-blue-50">
			<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
					d="M3 12l2-2m0 0l7-7 7 7m-9 2v8m-4 4h16a2 2 0 002-2v-8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
			</svg>
			HOME
		</a>
	</div>

	<div class="container mx-auto px-4 py-8">
		<div class="max-w-2xl mx-auto">
			<div class="text-center mb-8">
				<div class="w-24 h-24 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
					<svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
							d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
					</svg>
				</div>
				<h1 class="text-3xl font-bold text-gray-800 mb-2">Thông Tin Cá Nhân</h1>
				<p class="text-gray-600">Quản lý và cập nhật thông tin tài khoản của bạn</p>
			</div>

			<div class="bg-white rounded-xl shadow-lg overflow-hidden">
				<!-- Profile Header -->
				<div class="bg-gradient-to-r from-blue-600 to-indigo-600 px-6 py-8 text-white">
					<div class="flex items-center justify-between">
						<div>
							<h2 class="text-xl font-semibold mb-1" id="displayName">Nguyễn Văn An</h2>
							<p class="text-blue-100" id="displayEmail">nguyenvanan@email.com</p>
						</div>
						<button onclick="openEditModal()"
							class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-lg transition duration-200 flex items-center">
							<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
									d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z">
								</path>
							</svg>
							Chỉnh Sửa
						</button>
					</div>
				</div>

				<div class="p-6">
					<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
						<!-- Họ Tên -->
						<div class="flex items-center p-4 bg-gray-50 rounded-lg">
							<div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-4">
								<svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor"
									viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
										d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
								</svg>
							</div>
							<div>
								<p class="text-sm text-gray-500 font-medium">Họ và Tên</p>
								<p class="text-gray-800 font-semibold" id="profileName">Nguyễn Văn An</p>
							</div>
						</div>

						<div class="flex items-center p-4 bg-gray-50 rounded-lg">
							<div class="w-10 h-10 bg-pink-100 rounded-lg flex items-center justify-center mr-4">
								<svg class="w-5 h-5 text-pink-600" fill="none" stroke="currentColor"
									viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
										d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z">
									</path>
								</svg>
							</div>
							<div>
								<p class="text-sm text-gray-500 font-medium">Giới Tính</p>
								<p class="text-gray-800 font-semibold" id="profileGender">Nam</p>
							</div>
						</div>

						<div class="flex items-center p-4 bg-gray-50 rounded-lg">
							<div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center mr-4">
								<svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor"
									viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
										d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z">
									</path>
								</svg>
							</div>
							<div>
								<p class="text-sm text-gray-500 font-medium">Số Điện Thoại</p>
								<p class="text-gray-800 font-semibold" id="profilePhone">0123 456 789</p>
							</div>
						</div>

						<div class="flex items-center p-4 bg-gray-50 rounded-lg">
							<div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center mr-4">
								<svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor"
									viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
										d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
									</path>
								</svg>
							</div>
							<div>
								<p class="text-sm text-gray-500 font-medium">Email</p>
								<p class="text-gray-800 font-semibold" id="profileEmail">nguyenvanan@email.com</p>
							</div>
						</div>
					</div>

					<div class="mt-6 pt-6 border-t border-gray-200">
						<div class="flex items-center text-sm text-gray-500">
							<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
									d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
							</svg>
							Cập nhật lần cuối: <span id="lastUpdated" class="ml-1 font-medium">25/12/2024 14:30</span>
						</div>
					</div>
				</div>
			</div>

			<div id="successMessage"
				class="hidden mt-6 bg-green-100 border border-green-400 text-green-700 px-6 py-4 rounded-lg">
				<div class="flex items-center">
					<svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
						<path fill-rule="evenodd"
							d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
							clip-rule="evenodd"></path>
					</svg>
					<span class="font-semibold">Thành công!</span>
					<span class="ml-2">Thông tin cá nhân đã được cập nhật.</span>
				</div>
			</div>
		</div>
	</div>

	<div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
		<div class="bg-white rounded-xl p-6 w-full max-w-md mx-4 max-h-screen overflow-y-auto">
			<div class="flex items-center justify-between mb-6">
				<h3 class="text-xl font-semibold text-gray-800">Chỉnh Sửa Thông Tin</h3>
				<button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600">&times;</button>
			</div>
			<form id="editForm" class="space-y-4">
				<div>
					<label class="block text-sm font-medium text-gray-700">Họ và Tên</label>
					<input type="text" id="editName"
						class="mt-1 block w-full border rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500">
					<p id="nameError" class="text-red-500 text-sm hidden mt-1">Vui lòng nhập họ tên.</p>
				</div>
				<div>
					<label class="block text-sm font-medium text-gray-700">Giới Tính</label>
					<select id="editGender"
						class="mt-1 block w-full border rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500">
						<option value="">Chọn giới tính</option>
						<option value="Nam">Nam</option>
						<option value="Nữ">Nữ</option>
						<option value="Khác">Khác</option>
					</select>
					<p id="genderError" class="text-red-500 text-sm hidden mt-1">Vui lòng chọn giới tính.</p>
				</div>
				<div>
					<label class="block text-sm font-medium text-gray-700">Số Điện Thoại</label>
					<input type="text" id="editPhone"
						class="mt-1 block w-full border rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500">
					<p id="phoneError" class="text-red-500 text-sm hidden mt-1">Số điện thoại không hợp lệ.</p>
				</div>
				<div>
					<label class="block text-sm font-medium text-gray-700">Email</label>
					<input type="email" id="editEmail"
						class="mt-1 block w-full border rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500">
					<p id="emailError" class="text-red-500 text-sm hidden mt-1">Email không hợp lệ.</p>
				</div>
				<div class="flex justify-end gap-4 mt-6">
					<button type="button" onclick="closeEditModal()"
						class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 transition">Hủy</button>
					<button type="submit"
						class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition">Lưu</button>
				</div>
			</form>
		</div>
	</div>

	<!-- JS -->
	<script>
		(function () {
			const token = localStorage.getItem("token");
			const elements = {
				displayName: document.getElementById('displayName'),
				displayEmail: document.getElementById('displayEmail'),
				profileName: document.getElementById('profileName'),
				profileGender: document.getElementById('profileGender'),
				profilePhone: document.getElementById('profilePhone'),
				profileEmail: document.getElementById('profileEmail'),
				lastUpdated: document.getElementById('lastUpdated'),
				editModal: document.getElementById('editModal'),
				editForm: document.getElementById('editForm'),
				editName: document.getElementById('editName'),
				editGender: document.getElementById('editGender'),
				editPhone: document.getElementById('editPhone'),
				editEmail: document.getElementById('editEmail'),
				successMessage: document.getElementById('successMessage'),
				errorFields: {
					name: document.getElementById('nameError'),
					gender: document.getElementById('genderError'),
					phone: document.getElementById('phoneError'),
					email: document.getElementById('emailError')
				}
			};

			let userProfile = {};

			async function loadProfile() {
				try {
					const res = await fetch('http://localhost:8081/api/v1/user/me', {
						method: 'GET',
						headers: { 'Authorization': `Bearer ${token}`, 'accept': '*/*' }
					});
					const json = await res.json();
					if (json.status === 'SUCCESS') {
						const data = json.data;
						userProfile = {
							name: data.fullName,
							gender: data.gender,
							phone: data.phone,
							email: data.email,
							lastUpdated: new Date().toLocaleString('vi-VN')
						};
						displayProfile();
					}
				} catch (err) { console.error('GET /user/me failed', err); }
			}

			function displayProfile() {
				elements.displayName.textContent = userProfile.name;
				elements.displayEmail.textContent = userProfile.email;
				elements.profileName.textContent = userProfile.name;
				elements.profileGender.textContent = userProfile.gender;
				elements.profilePhone.textContent = userProfile.phone;
				elements.profileEmail.textContent = userProfile.email;
				elements.lastUpdated.textContent = userProfile.lastUpdated;
			}

			function openEditModal() {
				elements.editName.value = userProfile.name;
				elements.editGender.value = userProfile.gender;
				elements.editPhone.value = userProfile.phone;
				elements.editEmail.value = userProfile.email;
				clearErrors();
				elements.editModal.classList.remove('hidden');
			}

			function closeEditModal() { elements.editModal.classList.add('hidden'); clearErrors(); }
			function clearErrors() { Object.values(elements.errorFields).forEach(el => el.classList.add('hidden')); }

			function validateForm() {
				let valid = true;
				clearErrors();
				if (!elements.editName.value.trim()) { elements.errorFields.name.classList.remove('hidden'); valid = false; }
				if (!elements.editGender.value) { elements.errorFields.gender.classList.remove('hidden'); valid = false; }
				if (!/^[0-9]{10,11}$/.test(elements.editPhone.value.trim())) { elements.errorFields.phone.classList.remove('hidden'); valid = false; }
				if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(elements.editEmail.value.trim())) { elements.errorFields.email.classList.remove('hidden'); valid = false; }
				return valid;
			}

			function showSuccess() { elements.successMessage.classList.remove('hidden'); setTimeout(() => elements.successMessage.classList.add('hidden'), 3000); }

		
			elements.editForm.addEventListener('submit', async function (e) {
				e.preventDefault();
				if (!validateForm()) return;
				const payload = {
					fullName: elements.editName.value.trim(),
					gender: elements.editGender.value,
					phone: elements.editPhone.value.trim(),
					email: elements.editEmail.value.trim()
				};
				try {
					const res = await fetch("http://localhost:8081/api/v1/user/me", {
						method: "PUT",
						headers: {
							"Authorization": `Bearer ${token}`,
							"Content-Type": "application/json",
							"Accept": "application/json"
						},
						body: JSON.stringify(payload)
					});
					const json = await res.json();
					if (res.ok && json.status === "SUCCESS") {
						userProfile = {
							name: payload.fullName,
							gender: payload.gender,
							phone: payload.phone,
							email: payload.email,
							lastUpdated: new Date().toLocaleString("vi-VN")
						};
						displayProfile();
						closeEditModal();
						showSuccess();
					} else {
						if (json?.message?.includes("same.email")) {
							alert("Email đã tồn tại!");
						} else {
							alert("Cập nhật thất bại: " + (json?.message || "Unknown error"));
						}
					}
				} catch (err) {
					console.error("PUT /user/me failed", err);
					alert("Có lỗi kết nối, vui lòng thử lại!");
				}
			});


			// ===== Close modal click outside =====
			elements.editModal.addEventListener('click', function (e) { if (e.target === this) closeEditModal(); });

			document.addEventListener('DOMContentLoaded', loadProfile);
			window.openEditModal = openEditModal;
			window.closeEditModal = closeEditModal;

		})();
	</script>

</body>

</html>