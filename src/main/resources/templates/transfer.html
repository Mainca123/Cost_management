<!DOCTYPE html>
<html lang="vi">

<head>
	<meta charset="UTF-8" />
	<title>Chuy·ªÉn ti·ªÅn</title>
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<style>
		* {
			box-sizing: border-box;
			margin: 0;
			padding: 0;
		}

		body {
			font-family: "Segoe UI", Arial, Helvetica, sans-serif;
			background: linear-gradient(135deg, #e0f2ff, #f0f8ff);
			margin: 0;
			padding: 20px;
			min-height: 100vh;
			display: flex;
			justify-content: center;
			align-items: center;
		}

		.container {
			width: 100%;
			max-width: 480px;
			margin: 0 auto;
		}

		.panel {
			background: #fff;
			border-radius: 16px;
			box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
			padding: 32px;
			width: 100%;
			animation: fadeIn 0.5s ease-in-out;
		}

		@keyframes fadeIn {
			from {
				opacity: 0;
				transform: translateY(20px);
			}

			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		.header {
			text-align: center;
			margin-bottom: 28px;
			position: relative;
			padding-bottom: 16px;
		}

		.header::after {
			content: '';
			position: absolute;
			bottom: 0;
			left: 50%;
			transform: translateX(-50%);
			width: 60px;
			height: 3px;
			background: linear-gradient(to right, #036cff, #4da6ff);
			border-radius: 3px;
		}

		h2 {
			font-size: 24px;
			color: #036cff;
			margin-bottom: 8px;
			font-weight: 600;
		}

		.subtitle {
			color: #666;
			font-size: 14px;
		}

		.form-grid {
			display: grid;
			grid-gap: 18px;
		}

		.form-group {
			display: flex;
			flex-direction: column;
		}

		label {
			font-weight: 600;
			margin-bottom: 8px;
			font-size: 14px;
			color: #333;
			display: flex;
			align-items: center;
		}

		label::after {
			content: '*';
			color: #e32;
			margin-left: 4px;
		}

		label.optional::after {
			content: '(tu·ª≥ ch·ªçn)';
			color: #888;
			font-weight: normal;
			margin-left: 6px;
			font-size: 12px;
		}

		input,
		select {
			width: 100%;
			padding: 14px 16px;
			border: 1px solid #d0d7de;
			border-radius: 8px;
			font-size: 15px;
			transition: all 0.25s ease;
			background: #fff;
		}

		input:focus,
		select:focus {
			border-color: #036cff;
			outline: none;
			box-shadow: 0 0 0 3px rgba(3, 108, 255, 0.15);
		}

		.input-with-icon {
			position: relative;
		}

		.currency-icon {
			position: absolute;
			left: 16px;
			top: 50%;
			transform: translateY(-50%);
			font-weight: bold;
			color: #036cff;
			z-index: 2;
		}

		.input-with-icon input {
			padding-left: 40px;
		}

		.actions {
			display: grid;
			grid-template-columns: 1fr 2fr;
			gap: 12px;
			margin-top: 24px;
			padding-top: 20px;
			border-top: 1px solid #eee;
		}

		button {
			border: none;
			border-radius: 8px;
			padding: 14px 20px;
			font-size: 16px;
			cursor: pointer;
			font-weight: 600;
			transition: all 0.25s ease;
			display: flex;
			justify-content: center;
			align-items: center;
		}

		.btn-primary {
			background: #036cff;
			color: #fff;
			box-shadow: 0 4px 12px rgba(3, 108, 255, 0.25);
		}

		.btn-primary:hover {
			background: #0257d8;
			box-shadow: 0 6px 16px rgba(3, 108, 255, 0.35);
			transform: translateY(-1px);
		}

		.btn-secondary {
			background: #f6f8fa;
			color: #000;
			border: 1px solid #d0d7de;
		}

		.btn-secondary:hover {
			background: #eaeef2;
		}

		.hint {
			font-size: 13px;
			color: #666;
			margin-top: 6px;
			font-style: italic;
		}

		.receiver-status {
			margin-top: 6px;
			font-size: 13px;
			display: flex;
			align-items: center;
			gap: 8px;
		}

		.receiver-status .ok {
			color: #0a7f3e;
			font-weight: 600;
		}

		.receiver-status .err {
			color: #c62828;
			font-weight: 600;
		}

		.small-loading {
			width: 14px;
			height: 14px;
			border: 2px solid #d0d7de;
			border-top-color: #036cff;
			border-radius: 50%;
			animation: spin 0.9s linear infinite;
		}
	</style>
</head>

<body>

	<div class="container">
		<div class="panel">
			<div class="header">
				<h2>CHUY·ªÇN TI·ªÄN</h2>
				<p class="subtitle">Nh·∫≠p th√¥ng tin chuy·ªÉn ti·ªÅn</p>
			</div>

			<form id="transfer-form">
				<div class="form-grid">
					<!-- From bank -->
					<div class="form-group">
						<label for="from-bank">Ng√¢n h√†ng ngu·ªìn</label>
						<select id="from-bank" required>
							<option value="" disabled selected>-- Ch·ªçn ng√¢n h√†ng --</option>
						</select>
						<div id="from-bank-loading" class="hint" style="display:none;">ƒêang t·∫£i ng√¢n h√†ng ƒë√£ li√™n k·∫øt...
						</div>
						<div id="from-bank-info" class="hint" style="display:none;"></div>
					</div>

					<!-- To bank -->
					<div class="form-group">
						<label for="to-bank">Ng√¢n h√†ng ƒë√≠ch</label>
						<select id="to-bank" required disabled>
							<option value="" disabled selected>-- Ch·ªçn ng√¢n h√†ng --</option>
						</select>
						<div id="to-bank-loading" class="hint" style="display:none;">ƒêang t·∫£i danh s√°ch ng√¢n h√†ng...
						</div>
					</div>

					<div class="form-group">
						<label for="account">S·ªë t√†i kho·∫£n</label>
						<input type="text" id="account" placeholder="Nh·∫≠p s·ªë t√†i kho·∫£n ng∆∞·ªùi nh·∫≠n" required disabled />
						<div id="account-hint" class="receiver-status" style="display:none;">
							<span id="receiver-loader" class="small-loading" style="display:none;"></span>
							<span id="receiver-status-text"></span>
						</div>
					</div>

					<div class="form-group">
						<label for="receiver">T√™n ng∆∞·ªùi nh·∫≠n</label>
						<input type="text" id="receiver" placeholder="T√™n ng∆∞·ªùi nh·∫≠n s·∫Ω ƒë∆∞·ª£c x√°c th·ª±c" readonly
							required />
					</div>

					<div class="form-group">
						<label for="amount">S·ªë ti·ªÅn</label>
						<div class="input-with-icon">
							<span class="currency-icon">‚Ç´</span>
							<input type="number" id="amount" min="2000" placeholder="0" required disabled />
						</div>
						<p class="hint">S·ªë ti·ªÅn t·ªëi thi·ªÉu: 2.000 VND</p>
					</div>

					<div class="form-group">
						<label for="message" class="optional">N·ªôi dung chuy·ªÉn ti·ªÅn</label>
						<input type="text" id="message" placeholder="V√≠ d·ª•: Ti·ªÅn ph√≤ng tr·ªç th√°ng 10" disabled />
					</div>

					<!-- Category b·∫Øt bu·ªôc -->
					<div class="form-group">
						<label for="category">Danh m·ª•c chi ti√™u</label>
						<select id="category" required disabled>
							<option value="" disabled selected>-- Ch·ªçn danh m·ª•c --</option>
						</select>
						<div id="category-loading" class="hint" style="display:none;">ƒêang t·∫£i danh m·ª•c chi...</div>
					</div>
				</div>

				<div class="actions">
					<button class="btn-secondary" type="button" id="cancel-btn">H·ªßy b·ªè</button>
					<button class="btn-primary" type="submit" id="submit-btn">X√°c nh·∫≠n chuy·ªÉn ti·ªÅn</button>
				</div>
			</form>
		</div>
	</div>

	<script>
		function getToken() {
			return localStorage.getItem('accessToken') || localStorage.getItem('token') || '';
		}
		function authHeader() {
			const t = getToken();
			return t ? { 'Authorization': 'Bearer ' + t } : {};
		}
		function option(text, value) {
			const opt = document.createElement('option');
			opt.textContent = text;
			opt.value = value;
			return opt;
		}
		function show(el) { if (el) el.style.display = ''; }
		function hide(el) { if (el) el.style.display = 'none'; }

		const fromBankSelect = document.getElementById('from-bank');
		const toBankSelect = document.getElementById('to-bank');
		const accountInput = document.getElementById('account');
		const receiverInput = document.getElementById('receiver');
		const amountInput = document.getElementById('amount');
		const messageInput = document.getElementById('message');
		const categorySelect = document.getElementById('category');
		const form = document.getElementById('transfer-form');

		const receiverStatusWrap = document.getElementById('account-hint');
		const receiverLoader = document.getElementById('receiver-loader');
		const receiverStatusText = document.getElementById('receiver-status-text');
		const fromBankInfoEl = document.getElementById('from-bank-info');
		const fromBankLoading = document.getElementById('from-bank-loading');
		const toBankLoading = document.getElementById('to-bank-loading');
		const categoryLoading = document.getElementById('category-loading');

		let currentFromBankInfo = null;

		async function loadFromBanks() {
			try {
				show(fromBankLoading);
				const res = await fetch('http://localhost:8081/api/v1/bank/user', { headers: { ...authHeader() } });
				const json = await res.json();
				[...fromBankSelect.options].slice(1).forEach(o => o.remove());
				(json.data || []).forEach(b => fromBankSelect.appendChild(option(b.shortName, b.bankId)));
			} finally { hide(fromBankLoading); }
		}
		async function loadToBanks() {
			try {
				show(toBankLoading);
				const res = await fetch('http://localhost:8081/api/v1/banks', { headers: { ...authHeader() } });
				const json = await res.json();
				[...toBankSelect.options].slice(1).forEach(o => o.remove());
				(json.data || []).forEach(b => toBankSelect.appendChild(option(b.shortName, b.bankId)));
			} finally { hide(toBankLoading); }
		}
		async function loadCategories() {
			try {
				show(categoryLoading);
				const res = await fetch('http://localhost:8081/api/v1/user/categories', { headers: { ...authHeader() } });
				const json = await res.json();
				[...categorySelect.options].slice(1).forEach(o => o.remove());
				(json.data || []).forEach(c => categorySelect.appendChild(option(c.name, c.categoryId)));
			} finally { hide(categoryLoading); }
		}
		

		async function init() {
			if (!getToken()) {
				alert("Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.");
				return location.href = "http://localhost:8081/page/home";
			}
			await Promise.all([loadFromBanks(), loadToBanks(), loadCategories()]);
			const params = new URLSearchParams(window.location.search);
			const msg = params.get("message");
			if (msg === "ok") {
				const saved = localStorage.getItem("transferFullData");
				if (saved) {
					const parsed = JSON.parse(saved);
					try {
						const note = `T·ª´ ${parsed.fromAccountName} (${parsed.fromAccountNumber}) -> ${parsed.toAccountName} (${parsed.toAccountNumber})`;

						const payload = {
							type: parsed.categoryName,
							amount: parsed.amount,
							note: note,
							categoryId: parsed.categoryId || 0
						};
						const res = await fetch("http://localhost:8081/api/v1/bank/transaction", {
							method: "POST",
							headers: {
								...authHeader(),
								"Content-Type": "application/json",
								"Accept": "*/*"
							},
							body: JSON.stringify(payload)
						});
						if (res.ok) {
							alert("‚úÖ Giao d·ªãch ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n th√†nh c√¥ng!");
							localStorage.removeItem("transferFullData");
							localStorage.removeItem("transferPayload");
						} else {
							const err = await res.json();
							alert("‚ùå Ghi nh·∫≠n giao d·ªãch th·∫•t b·∫°i: " + (err.message || "L·ªói kh√¥ng x√°c ƒë·ªãnh"));
						}
					} catch (e) {
						console.error("Transaction log error", e);
						alert("‚ùå C√≥ l·ªói x·∫£y ra khi ghi nh·∫≠n giao d·ªãch.");
					} finally {
						window.location.href = "http://localhost:8081/page/home";
					}
				}
			}
		}

		// ch·ªçn ng√¢n h√†ng ngu·ªìn ‚Üí unlock b∆∞·ªõc ti·∫øp
		fromBankSelect.addEventListener('change', async () => {
			if (!fromBankSelect.value) return;
			toBankSelect.disabled = false;
			try {
				const res = await fetch(`http://localhost:8081/api/v1/bank/user/information?bankId=${fromBankSelect.value}`, { headers: { ...authHeader() } });
				const json = await res.json();
				currentFromBankInfo = json.data;
				fromBankInfoEl.style.display = '';
				fromBankInfoEl.textContent = `S·ªë TK: ${currentFromBankInfo.accountNumber} ‚Äî Ch·ªß: ${currentFromBankInfo.accountName}`;
			} catch { }
		});

		// check t√™n ng∆∞·ªùi nh·∫≠n
		async function checkReceiverName() {
			const account = accountInput.value.trim();
			if (!account || !toBankSelect.value) return;
			if (!currentFromBankInfo?.accessToken) return;

			// ki·ªÉm tra tr√πng s·ªë t√†i kho·∫£n
			if (currentFromBankInfo.accountNumber === account) {
				alert("‚ö†Ô∏è T√†i kho·∫£n nh·∫≠n kh√¥ng ƒë∆∞·ª£c tr√πng t√†i kho·∫£n g·ª≠i.");
				accountInput.value = "";
				receiverInput.value = "";
				return;
			}

			show(receiverStatusWrap); show(receiverLoader);
			try {
				const bankName = toBankSelect.options[toBankSelect.selectedIndex]?.text;
				const res = await fetch(`http://localhost:8080/api/v1/bank/fullname?bankName=${bankName}&bankNumber=${account}`, {
					headers: { 'Authorization': 'Bearer ' + currentFromBankInfo.accessToken }
				});
				const json = await res.json();
				if (json.status === "SUCCESS") {
					receiverInput.value = json.message;
					receiverStatusText.textContent = "ƒê√£ x√°c th·ª±c t√™n ng∆∞·ªùi nh·∫≠n";
					receiverStatusText.className = "ok";
					amountInput.disabled = false;
					messageInput.disabled = false;
					categorySelect.disabled = false;
				} else {
					receiverStatusText.textContent = "Kh√¥ng x√°c ƒë·ªãnh ng∆∞·ªùi nh·∫≠n";
					receiverStatusText.className = "err";
				}
			} finally { hide(receiverLoader); }
		}

		accountInput.addEventListener('blur', checkReceiverName);
		toBankSelect.addEventListener('change', () => { if (accountInput.value) checkReceiverName(); accountInput.disabled = false; });

		// ‚úÖ ki·ªÉm tra s·ªë d∆∞ khi nh·∫≠p ti·ªÅn
		amountInput.addEventListener('blur', async () => {
			if (!amountInput.value || !currentFromBankInfo) return;
			try {
				const payload = {
					bankName: fromBankSelect.options[fromBankSelect.selectedIndex]?.text,
					bankNumber: currentFromBankInfo.accountNumber,
					amount: Number(amountInput.value)
				};
				const res = await fetch("http://localhost:8080/api/v1/banks/balance", {
					method: "POST",
					headers: {
						"Authorization": "Bearer " + currentFromBankInfo.accessToken,
						"Content-Type": "application/json",
						"Accept": "*/*"
					},
					body: JSON.stringify(payload)
				});
				const json = await res.json();
				if (!(json.status === "SUCCESS" && json.data === true)) {
					alert("‚ö†Ô∏è S·ªë d∆∞ kh√¥ng ƒë·ªß. Vui l√≤ng nh·∫≠p l·∫°i s·ªë ti·ªÅn.");
					amountInput.value = "";
				}
			} catch (e) {
				console.error("Balance check error", e);
			}
		});

		form.addEventListener('submit', e => {
			e.preventDefault();

			if (!fromBankSelect.value || !toBankSelect.value || !accountInput.value ||
				!receiverInput.value || !amountInput.value || !categorySelect.value) {
				return alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin");
			}

			// payload d√πng cho API
			const payload = {
				fromBank: {
					bankName: fromBankSelect.options[fromBankSelect.selectedIndex].text,
					accountNumber: currentFromBankInfo.accountNumber,
					accountName: currentFromBankInfo.accountName
				},
				toBank: {
					id: toBankSelect.value,
					bankName: toBankSelect.options[toBankSelect.selectedIndex].text,
					accountNumber: accountInput.value,
					accountName: receiverInput.value
				},
				amount: Number(amountInput.value),
				accessToken: currentFromBankInfo.accessToken
			};

			// üëâ th√™m object ƒë·∫ßy ƒë·ªß ƒë·ªÉ l∆∞u tr·ªØ l·∫°i to√†n b·ªô d·ªØ li·ªáu ng∆∞·ªùi d√πng nh·∫≠p
			const fullData = {
				fromBankId: fromBankSelect.value,
				fromBankName: fromBankSelect.options[fromBankSelect.selectedIndex].text,
				fromAccountNumber: currentFromBankInfo.accountNumber,
				fromAccountName: currentFromBankInfo.accountName,
				toBankId: toBankSelect.value,
				toBankName: toBankSelect.options[toBankSelect.selectedIndex].text,
				toAccountNumber: accountInput.value,
				toAccountName: receiverInput.value,
				amount: Number(amountInput.value),
				message: messageInput.value,
				categoryId: categorySelect.value,
				categoryName: categorySelect.options[categorySelect.selectedIndex].text
			};

			// l∆∞u c·∫£ 2 v√†o localStorage
			localStorage.setItem("transferPayload", JSON.stringify(payload));
			localStorage.setItem("transferFullData", JSON.stringify(fullData));

			const query = new URLSearchParams({
				data: JSON.stringify(payload)
			}).toString();

			window.location.href = "http://localhost:8080/auth/transfer?" + query;
		});

		document.getElementById('cancel-btn').addEventListener('click', () => location.href = "http://localhost:8081/page/home");

		document.addEventListener('DOMContentLoaded', init);
	</script>

</body>

</html>